---
title: "Making Visualizations with Cal Enviroscreen"
author: "Lyndsay Miles"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#libraries
library(tidyverse)
library(readxl)
library(kableExtra)
library(reactable)
```

Data extracted from OEHHA, https://oehha.ca.gov/calenviroscreen/report/calenviroscreen-40, "CalEnviroScreen 4.0 Excel and Data Dictionary PDF"

```{r}
enviro <- read_excel("data/calenviroscreen40resultsdatadictionary_F_2021.xlsx", sheet = 1, na = "---") 
demog <- read_excel("data/calenviroscreen40resultsdatadictionary_F_2021.xlsx", sheet = 2, na = "---") 
#view(data)
```


```{r}
#removed first row which states "Demographic data (total population, age groups and race/ethnicity) by census tract were extracted from the 2019 American Community Survey."
demog_clean <- demog %>% 
  rename_with( ~ tolower(gsub(" ", "", .x, fixed = TRUE)))%>%
  rename(county=californiacounty) %>%
  group_by(county)%>% 
  drop_na()

#dropping NAs which impacts counties: LA, San Diego, Riverside, San Bernardino, San Mateo, Santa Barbara, Solano, Monterey, 
```

```{r}
#demographics by county
demog_clean_county <- demog_clean %>%
  group_by(county) %>% 
  summarize(totalpop = sum(totalpopulation),
            avg_children = mean(`children<10years(%)`),
            avg_10_64 = mean(`pop10-64years(%)`),
            avg_elderly = mean(`elderly>64years(%)`),
            avg_hispanic = mean(`hispanic(%)`),
            avg_white = mean(`white(%)`),
            avg_black = mean(`africanamerican(%)`),
            avg_aian = mean(`nativeamerican(%)`),
            avg_asian = mean(`asianamerican(%)`),
            avg_other = mean(`other/multiple(%)`))%>%
  arrange(desc(totalpop))
```

```{r}
#in table format
kable(demog_clean_county,
      booktabs = T,
      caption = "Demographics by California County") %>%
  footnote(general = "OEHHA",
           general_title = "Data Source") %>%
  kable_styling(full_width = T)
```

```{r}
#clean data
enviro_clean <- enviro %>% 
  rename_with( ~ tolower(gsub(" ", "", .x, fixed = TRUE)))%>%
  rename(county=californiacounty) %>% 
  mutate(lowbirthweight = as.numeric(lowbirthweight),
         education = as.numeric(education),
         linguisticisolation = as.numeric(linguisticisolation),
         unemployment = as.numeric(unemployment),
         housingburden = as.numeric(housingburden)) %>%
  drop_na(`ces4.0score`)
  
#I only drop NA values for ces4.0 score. 1965 NA values before drop, 720 remain
#review of other missing values: counties with no NAs for lowbirthweight (29); education (42), linguisticisolation (15), unemployment (12), housing (37), poverty (57). Only 5 counties have a complete data set for the chosen variables after dropping NAs for ces4.0score
```

```{r}
#enviro_clean grouped by county
enviro_clean_county <- enviro_clean %>%
  group_by(county)%>%
  summarize(totalpop = sum(totalpopulation),
            avg_ces_score = mean(`ces4.0score`),
            avg_pollutionburden = mean(pollutionburden),
            avg_asthma = mean(asthma),
            avg_lowbirthweight = mean(lowbirthweight),
            avg_cvd = mean(cardiovasculardisease),
            avg_education = mean(education),
            avg_lingisolation = mean(linguisticisolation),
            avg_poverty = mean(poverty),
            avg_unemployment = mean(unemployment),
            avg_housingburden = mean(housingburden)
            )

```

```{r} 
kable(enviro_clean_county,
      booktabs = T,
      caption = "Selected Health Concerns, related Environmental and Social Factors, by California County") %>%
  footnote(general = "OEHHA",
           general_title = "Data Source") %>%
  kable_styling(full_width = T)
```


```{r}
#Explore asthma and related risk factors & associated illness
enviro_clean_asthma <- enviro_clean %>%
  select(county, totalpopulation, `ces4.0score`, `pm2.5`, dieselpm, pesticides, traffic, pollutionburden, asthma, cardiovasculardisease, poverty, housingburden) %>% 
  group_by(county) %>% 
  summarize(totalpop = sum(totalpopulation), 
            avg_ces_score = mean(`ces4.0score`),
            avg_pm2.5 = mean(`pm2.5`),
            avg_diesel = mean(dieselpm),
            avg_pesticides = mean(pesticides),
            avg_traffic = mean(traffic),
            avg_pollutionburden = mean(pollutionburden),
            avg_asthma = mean(asthma),
            avg_cvd = mean(cardiovasculardisease),
            avg_poverty = mean(poverty))

kable(enviro_clean_asthma,
      booktabs = T,
      caption = "Asthma and CVD rates, related environmental risks, by California County") %>%
  footnote(general = "OEHHA",
           general_title = "Data Source") %>%
  kable_styling(full_width = T)
  
```

```{r}
reactable(enviro_clean_asthma)
```


